<!DOCTYPE html>
<html>
  <head>
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="viewport" initial-scale=1, maximum-scale=1, user-scalable=0">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
   <link rel="apple-touch-icon" href="icon.png">
    <style>
      * {box-sizing: border-box;
        font-family: "SF Pro Display", system-ui;
        } 
      body {
        background-color: #00669950; 
        text-align: right;
        overflow: hidden;
      }
      #waterInput {
        position: fixed;
        z-index: 998;
        top: 60%;
        padding: 4vw;
        width: 96%;
        left: 2vw;
        font-size: 32pt;
        background-color: #ffffff90;
    -webkit-backdrop-filter: blur(40px);
        border:none;
        border-radius: 35px;
        color: black;
      }
      button, input {
        font-size: 5vw;
        font-weight: light;
        height: 15vw;
        width: 20vw;
        background-color: #ffffff50;
        color: black;
    -webkit-backdrop-filter: blur(30px);
        border-radius: 20px;
        border:none;
        text-align:center;
        vertical-align: middle;
      }
      #svBt { width: 31vw;}
      
      #customInput {
        width: 54vw;
        caret-color: #00000090;
        text-align: left;
      }
      #inputSaveList, #buttonList {
        vertical-align: middle;
        justify-content: space-between;
        display: flex;
        padding:0;
      }
      #buttonList, #header {margin-bottom: 3vw;}
      
      #header {
        display: flex;
        padding-top: 0vw;
        vertical-align: bottom;
        text-align: bottom;
        height: 12vw;
      }
      #logTitle, #milliLiter, #currentAmount {
        font-size: 10vw;
        font-weight: bold;
      }
      .added-cell {font-weight: bold;}
      
      #roundedCorners{
        border-radius: 40px;
        overflow: scroll;
        width: 94vw;
        max-height: 78vh;
        position: fixed;
        left: 3vw;
        right: 3vw;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        text-align: center;
      }
      thead {
        font-size: 6vw;
        background-color: #ffffffaa;
    -webkit-backdrop-filter: blur(40px);
        width: 25vw;
        top: 0px;
        position: sticky;
        border: none;
      }
      thead tr {height: 12vw;}
      tbody {
        font-size: 4vw;
        height:91%;
      }
      td {
        width: 25vw;
        height: 9vw;
        border: none;
      }
      #addRowsButton {
        z-index: 999;
        height: 10vw;
        width: 10vw;
        font-size: 36pt;
        padding:0;
        margin-right: 3vw;
        margin-top: 3vw;
        margin-bottom: 3vw;
      }
      tbody tr:nth-child(even) {background-color: #ffffffaa;}
      tbody tr:nth-child(odd) {background-color: #ffffff50;}
    </style>
  </head>
  <body>
  <form id="waterInput" action="" method="get" onsubmit="return false">
  <div id="header">
  <div id=logTitle>Log:&nbsp;</div>
  <div id="currentAmount">0</div>
  <div id="milliLiter">ml</div>
  </div>
  <div id="buttonList">
  
<button id="btn-125" value="125">125 ml</button>
<button id="btn-200" value="200">200 ml</button>
<button id="btn-250" value="250">250 ml</button>
<button id="btn-500" value="500">500 ml</button>

  </div>
  <div id=inputSaveList>
  <input type="number" placeholder="Enter ml" id="customInput">
  <button id="svBt" type="submit">Save</button>
  </div>
</form>
<button id="addRowsButton" onclick="openCsvFile()">+</button>
<div id="roundedCorners">
<table id="waterLog">
        <thead>
        <tr>
  <td>Date</td><td>Time</td><td>Amount</td>
        </tr>
      </thead>
        <tbody>
        </tbody>
      </table>
  </div>
  <script>
  const table = document.getElementById("waterLog");
  const tbody = table.createTBody();
  const date = new Date().toLocaleDateString('de-DE', {year: '2-digit', month: '2-digit', day: '2-digit'});
  const time = new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});


function addRow(loggedAmount) {
  const newRow = [date, time, loggedAmount];
  const newTableRow = table.tBodies[0].insertRow(0);

  newRow.forEach((cell, cellIndex) => {
    const td = newTableRow.insertCell(cellIndex);
    td.textContent = cell;
    // mark added cells
    td.classList.add("added-cell");
  });

let updatedAmount = 0;
const rowsU = document.querySelectorAll("tbody tr");
rowsU.forEach((line) => {
  const cellsU = line.cells;
  const rowDate = cellsU[0].textContent;
  const rowTime = Number(cellsU[1].textContent.split(":")[0]);
  if (rowDate === date && rowTime >= 2) {
    updatedAmount += Number(cellsU[2].textContent);
  }
});
document.getElementById("currentAmount").textContent = updatedAmount;
}
// ==================================================
window.addEventListener('load', () => {
  // Delay execution by 50 milliseconds
  window.setTimeout(() => {
    const data = JSON.parse(localStorage.getItem('waterLog'));
    if (data) {
      const tableBody = document.querySelector('table tbody');
      // iterate through the data array from end to beginning
      for (let i = data.length - 1; i >= 0; i--) {
        const row = data[i];
        const tableRow = document.createElement('tr');
        const dateCell = document.createElement('td');
        dateCell.textContent = row.date;
        const timeCell = document.createElement('td');
        timeCell.textContent = row.time;
        const amountCell = document.createElement('td');
        amountCell.textContent = row.amount;
        tableRow.appendChild(dateCell);
        tableRow.appendChild(timeCell);
        tableRow.appendChild(amountCell);
        tableBody.insertBefore(tableRow, tableBody.firstChild);
      }
    }
let updatedAmount = 0;
const rowsU = document.querySelectorAll("tbody tr");
rowsU.forEach((line) => {
  const cellsU = line.cells;
  const rowDate = cellsU[0].textContent;
  const rowTime = Number(cellsU[1].textContent.split(":")[0]);
  if (rowDate === date && rowTime >= 2) {
    updatedAmount += Number(cellsU[2].textContent);
  }
});
document.getElementById("currentAmount").textContent = updatedAmount;
  }, 50);
});

window.addEventListener('beforeunload', () => {
  const rows = document.querySelectorAll("tbody tr");
  const data = [];
  rows.forEach((row) => {
    const cells = row.querySelectorAll('td');
    const rowData = {
      date: cells[0].innerHTML,
      time: cells[1].innerHTML,
      amount: cells[2].innerHTML
    };
    data.push(rowData);
  });
  localStorage.setItem('waterLog', JSON.stringify(data));
});
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    const rows = document.querySelectorAll("tbody tr");
    const data = [];
    rows.forEach((row) => {
      const cells = row.querySelectorAll('td');
      const rowData = {
        date: cells[0].innerHTML,
        time: cells[1].innerHTML,
        amount: cells[2].innerHTML
      };
      data.push(rowData);
    });
    localStorage.setItem('waterLog', JSON.stringify(data));
  }
});
// ==================================================
function addCsvToTable(csvData) {
  const rows = csvData.split('\n').map(row => row.split(';'));
  rows.slice(0, 30).forEach((row, rowIndex) => {
    const tr = tbody.insertRow();
    row.forEach((cell, cellIndex) => {
      const td = tr.insertCell();
      td.textContent = cell;
    });
  });
let updatedAmount = 0;
const rowsU = document.querySelectorAll("tbody tr");
rowsU.forEach((line) => {
  const cellsU = line.cells;
  const rowDate = cellsU[0].textContent;
  const rowTime = Number(cellsU[1].textContent.split(":")[0]);
  if (rowDate === date && rowTime >= 2) {
    updatedAmount += Number(cellsU[2].textContent);
  }
});
document.getElementById("currentAmount").textContent = updatedAmount;
 
 // Store the CSV data in a global variable for later use
  window.csvWaterLog = csvData;
}

function openCsvFile() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.csv';
  fileInput.onchange = () => {
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const csvData = reader.result;
      addCsvToTable(csvData);
    };
    reader.readAsText(file);
  };
  fileInput.click();
}

const saveButton = document.getElementById("svBt");
const customInput = document.getElementById("customInput");

saveButton.addEventListener("click", () => {
  const value = customInput.value;
  if (value !== "") {
  addRow(value);
  }
});

const btn125 = document.getElementById("btn-125");
const btn200 = document.getElementById("btn-200");
const btn250 = document.getElementById("btn-250");
const btn500 = document.getElementById("btn-500");

btn125.addEventListener("click", function() {
btn125.classList.add("slide-fwd-center");
const value = btn125.value;
addRow(value);
});

btn200.addEventListener("click", () => {
  const value = btn200.value;
  addRow(value);
});
btn250.addEventListener("click", () => {
  const value = btn250.value;
  addRow(value);
});
btn500.addEventListener("click", () => {
  const value = btn500.value;
  addRow(value);
});
const body = document.querySelector('body');
  if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
     body.classList.add('dark-theme');
  } else {
     body.classList.remove('dark-theme');
  }
    </script>
  </body>
</html>
