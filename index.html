<!DOCTYPE html>
<html>
<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" initial-scale="1" maximum-scale="1" user-scalable="0">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon.png">

<style>
* {box-sizing: border-box;font-family: system-ui, iconMode}

::-webkit-scrollbar {
  overscroll-behavior: none;
  display: none;
}

body {
  margin:0;
  background: rgb(62,86,131);
  background: linear-gradient(0deg, rgba(62,86,131,1) 0%, rgba(81,142,186,1) 100%);
  text-align: right;
  touch-action: none;
  /*position: fixed;*/
}
#backgroundFix {
  /*background-color: rgba(255,255,255,.43);*/
  /*Fix for safari gap margin-bottom:-3px; */
  background: rgb(255,255,255);
  background: linear-gradient(0deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.43) 100%);
  box-shadow:0px -3px 0px 0px rgba(255,255,255,.43);
  /*Fix for safari gap */
  margin-top: 0px;
  height: 100vh;
  width: 100vw;
}

.waves {
  /* change this to animate water level 85 => 0 */
  /* change this margin-top: 85vh; to animate water level */
  width: 100%;
  height:15vh;
  min-height: 6vw;
  max-height: 10vw;
}
#niceWaves {
  margin-top: 15vh;
}
    
#waterInput {
  position: absolute;
  z-index: 998;
  top: 60vh;
  padding: 4vw;
  width: 96%;
  left: 2vw;
  background-color: #ffffff30;
  -webkit-backdrop-filter: blur(45px);
  border:none;
  border-radius: 35px;
  color: black;
  box-shadow:0px 0px 10px -4px #00000080;
}
button, input {
  font-size: 36pt;
  height: 15vw;
  width: 20vw;
  background-color: #ffffff80;
  color: black;
  -webkit-backdrop-filter: blur(35px);
  border-radius: 20px;
  border:none;
  text-align:center;
  vertical-align: middle;
}
#svBt { width: 31vw;}

#customInput {
  width: 54vw;
  caret-color: #00000090;
  text-align: left;
  outline: none;
  padding: 4vw;
}
#customInput:focus {
  outline: none
  -webkit-backdrop-filter: blur(55px);
}
#customInput::placeholder {
  opacity: 0.6;
  color:black;
}
#inputSaveList, #buttonList {
  vertical-align: middle;
  justify-content: space-between;
  display: flex;
  padding:0;
}
#buttonList, #header {margin-bottom: 3vw;}

#header {
  display: flex;
  padding-top: 0vw;
  vertical-align: bottom;
  text-align: bottom;
  height: 12vw;
}
#logTitle, #milliLiter, #currentAmount {
  font-size: 54pt;
  font-weight: bold;
}
.added-cell {font-weight: bold;}

#roundedCorners{
  position: absolute;                           
  border-radius: 40px;
  -webkit-backdrop-filter: blur(4px);
  overflow: scroll;
  overscroll-behavior: none;
  -webkit-overscroll-behavior: none;
  width: 92vw;
  max-height: 71vh;
  top: 20vw;
  left: 4vw;
  right: 4vw;
  box-shadow: 0px 0px 10px -2px #00669950;
}
table {
  border-collapse: collapse;
  width: 100%;
  text-align: center;
}
tbody {
  font-size: 24pt;
  height:91%;
}
td {
  width: 25vw;
  height: 9vw;
  border: none;
}
.tableHeadData {
  filter: drop-shadow(0px 0px 2px #00000040);
  background-color: #ffffff90;
}
.tableHead {background-color: #ffffffcc;}
      
thead tr {
  font-size: 26pt;
  width: 25vw;
  border: none;
  -webkit-backdrop-filter: blur(35px);
  top: 0px;
  height: 12vw;
  z-index: 1;
  position: sticky;
}
#menuButton {
  z-index: auto;
  height: 12vw;
  width: 12vw;
  font-size: 26pt;
  font-weight: bold;
  padding:0;
  margin-right: 4vw;
  margin-top: 3vw;
  margin-bottom: 2vw;
  box-shadow: 0px 0px 10px -2px #00669960;
}

#popup {
  position: fixed;
  top: 55vh;
  width: 80vw;
  background: #00000020;
  -webkit-backdrop-filter: blur(35px);
  box-shadow: 0px 0px 100vw 75vw #000000cc;
  border: none;
  padding: 5%;
  border-radius: 35px;
  display: none;
  z-index: 999;
  left: 10%;
}

#ifttt-form input, #ifttt-form button {
  height: 15vw;  
  padding: 10pt;
  height: 3;
  border: none;
  outline: none;
  background-color: #ffffff70;
  border-radius: 22px;
  font-size: 36pt;
}

#ifttt-form button {
  padding: 5pt;
  width: 31%;
}

#ifttt-form input {
  width: 100%;
  margin-bottom: 3.2%;
  text-align: left;
  padding-left: 22pt;
}

#ifttt-form input:focus {
  background-color: #ffffffaa;
}

::placeholder {color: #00000090; font-size: 32pt;}

#popBtnContainer {
  display: flex;
  justify-content: space-between;
  margin-left: auto;
  margin-right: auto;
}

#popInpContainer {
  justify-content: space-evenly;
  margin-left: auto;
  margin-right: auto;
}

tbody tr:nth-child(even) {background-color: #ffffff85;}
tbody tr:nth-child(odd) {background-color: #ffffff50;}

/* Animation */
.parallax > use {
  animation: move-forever 25s cubic-bezier(.55,.5,.45,.5)     infinite;
}
.parallax > use:nth-child(1) {
  animation-delay: -2s;
  animation-duration: 7s;
}
.parallax > use:nth-child(2) {
  animation-delay: -3s;
  animation-duration: 10s;
}
.parallax > use:nth-child(3) {
  animation-delay: -4s;
  animation-duration: 13s;
}
.parallax > use:nth-child(4) {
  animation-delay: -5s;
  animation-duration: 20s;
}
@keyframes move-forever {
  0% {
   transform: translate3d(-90px,0,0);
  }
  100% { 
    transform: translate3d(85px,0,0);
  }
}
.slide-in-blurred-top {
  animation: slide-in-blurred-top 0.4s cubic-bezier(0.230, 1.000, 0.320, 1.000) both;
  }
.slide-out-blurred-top {
  animation: slide-out-blurred-top 0.20s cubic-bezier(0.755, 0.050, 0.855, 0.060) both;
  }

@keyframes slide-in-blurred-top {
  0% {
    transform: translateY(-1000px) scaleY(2.5) scaleX(0.2);
    transform-origin: 50% 0%;
    filter: blur(40px);
    opacity: 0;
  }
  100% {
    transform: translateY(0) scaleY(1) scaleX(1);
    transform-origin: 50% 50%;
    filter: blur(0);
    opacity: 1;
  }
}
@keyframes slide-out-blurred-top {
  0% {
    transform: translateY(0) scaleY(1) scaleX(1);
    transform-origin: 50% 0%;
    filter: blur(0);
    opacity: 1;
  }
  100% {
    transform: translateY(-1000px) scaleY(2) scaleX(0.2);
    transform-origin: 50% 0%;
    filter: blur(40px);
    opacity: 0;
  }
}

@keyframes riseWaterInitial {
  from {
    margin-top: 100%;
    transform: scaleY(1);
  }
  to {
    margin-top: 88%;
    transform: scaleY(1);
  }
}

@keyframes riseWater {
  from {
    margin-top:: var(--water-level-start);
    transform: scaleY(1);
  }
  to {
    margin-top:: var(--water-level-end);
    transform: scaleY(1);
  }
}
/* Animation End */
</style>
</head>
<body>

<button id="menuButton" onclick="showPopup()">+</button>
<div id="popup">
  <form id="ifttt-form">
    <div id="popInpContainer">
    <input type="text" placeholder="Water Target" name="waterTarget" id="formInput1">
    <input type="text" placeholder="Enter IFTTT Key" name="iftttKeyInput" id="formInput2">
    </div>
    <div id=popBtnContainer>
    <button onclick="clearLocalStorage()" id="csvBtn">Wipe Data</button>
    <button onclick="openCsvOrFont()" id="fontBtn">Add File</button>
    <button type="submit" id="saveButton">Save</button>
    </div>
  </form>
</div>
  
<div id="niceWaves">
  <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
    <defs>
    <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
    </defs>
    <g class="parallax">
      <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(255,255,255,0.1" />
      <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(255,255,255,0.2)" />
      <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(255,255,255,0.1)" />
      <use xlink:href="#gentle-wave" x="48" y="7" fill="rgba(255,255,255,0.1)" />
    </g>
  </svg>
</div>
  
<div id="backgroundFix">
  
<form id="waterInput" action="" method="get" onsubmit="return false">
  <div id="header">
    <div id=logTitle>Log:&nbsp;</div>
    <div id="currentAmount">0</div>
    <div id="milliLiter">ml</div>
  </div>
  
  <div id="buttonList">
    <button id="btn-125" value="125">125 ml</button>
    <button id="btn-200" value="200">200 ml</button>
    <button id="btn-250" value="250">250 ml</button>
    <button id="btn-500" value="500">500 ml</button>
  </div>
  
  <div id=inputSaveList>
    <input type="number" placeholder="Enter ml" id="customInput">
    <button id="svBt" type="submit">Save</button>
  </div>
</form>
  
<div id="roundedCorners">
  <table id="waterLog">
    <thead class="tableHead">
      <tr>
        <td>Date</td><td>Time</td><td>Amount</td>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
  
</div>
<script>
// ===== 
const table = document.getElementById("waterLog");
const tbody = table.createTBody();
const date = new Date().toLocaleDateString('de-DE', {year: '2-digit', month: '2-digit', day: '2-digit'});
const time = new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});

const tbodyTemp = document.querySelector('tbody');
const theadTemp = document.querySelector('thead');

tbodyTemp.addEventListener('DOMNodeInserted', () => {
  setTimeout(() => {
    if (tbodyTemp.querySelectorAll('tr').length > 0) {
      theadTemp.classList.remove('tableHead');
      theadTemp.classList.add('tableHeadData');
    }
  }, 50);
});

function addRow(loggedAmount) {
  const newRow = [date, time, loggedAmount];
  const newTableRow = table.tBodies[0].insertRow(0);

  newRow.forEach((cell, cellIndex) => {
    const td = newTableRow.insertCell(cellIndex);
    td.textContent = cell;
    // mark added cells
    td.classList.add("added-cell");
  });

let updatedAmount = 0;
const rowsU = document.querySelectorAll("tbody tr");
rowsU.forEach((line) => {
  const cellsU = line.cells;
  const rowDate = cellsU[0].textContent;
  const rowTime = Number(cellsU[1].textContent.split(":")[0]);
  if (rowDate === date && rowTime >= 2) {
    updatedAmount += Number(cellsU[2].textContent);
  }
});
document.getElementById("currentAmount").textContent = updatedAmount;
}
// ===================== loading and unloading ====================
function loadSelectedFont() {
  const fontData = localStorage.getItem('selectedFont');
  if (fontData) {
    const tableHeaders = document.querySelectorAll('thead tr td');
    if (tableHeaders.length > 0) {
      tableHeaders[0].textContent = '\u{100249}';
      tableHeaders[1].textContent = '\u{10042b}';
      tableHeaders[2].textContent = '\u{101384}';
    }
    const menuButtonIcon = document.querySelector('#menuButton')
      menuButtonIcon.style.fontSize = '26pt'
      menuButtonIcon.textContent = '\u{100306}';
          const css = `@font-face {
      font-family: 'iconMode';
      src: url('data:font/opentype;charset=utf-8;base64,${fontData}');
      font-display: swap;
    }`;
    const style = document.createElement('style');
    style.appendChild(document.createTextNode(css));
    document.head.appendChild(style);
  }
}

window.addEventListener('load', () => {
  // Delay execution by 50 milliseconds
  loadSelectedFont()
// change menu placeholders
  const currentTargetWater = localStorage.getItem('waterTarget')
  if (!localStorage.getItem('waterTarget')){} else {
      const popupWaterInput = document.getElementById('formInput1')
      popupWaterInput.setAttribute('placeholder', 'Current Target: ' + currentTargetWater + 'ml')
  }
  if (!localStorage.getItem('iftttKey')){} else {
      const popupIftttInput = document.getElementById('formInput2')
      popupIftttInput.setAttribute('placeholder', 'IFTTT key found')
  }
  window.setTimeout(() => {
    const data = JSON.parse(localStorage.getItem('waterLog'));
    if (data) {
      const tableBody = document.querySelector('table tbody');
      // iterate through the data array from end to beginning
      for (let i = data.length - 1; i >= 0; i--) {
        const row = data[i];
        const tableRow = document.createElement('tr');
        const dateCell = document.createElement('td');
        dateCell.textContent = row.date;
        const timeCell = document.createElement('td');
        timeCell.textContent = row.time;
        const amountCell = document.createElement('td');
        amountCell.textContent = row.amount;
        tableRow.appendChild(dateCell);
        tableRow.appendChild(timeCell);
        tableRow.appendChild(amountCell);
        tableBody.insertBefore(tableRow, tableBody.firstChild);
      }
    }
let updatedAmount = 0;
const rowsU = document.querySelectorAll("tbody tr");
rowsU.forEach((line) => {
  const cellsU = line.cells;
  const rowDate = cellsU[0].textContent;
  const rowTime = Number(cellsU[1].textContent.split(":")[0]);
  if (rowDate === date && rowTime >= 2) {
    updatedAmount += Number(cellsU[2].textContent);
  }
});
document.getElementById("currentAmount").textContent = updatedAmount;
  }, 50);
});

function saveDataToLocalStorage() {
  const rows = document.querySelectorAll("tbody tr");
  const data = [];
  rows.forEach((row) => {
    const cells = row.querySelectorAll('td');
    const rowData = {
      date: cells[0].innerHTML,
      time: cells[1].innerHTML,
      amount: cells[2].innerHTML
    };
    data.push(rowData);
  });
  localStorage.setItem('waterLog', JSON.stringify(data));
}

window.addEventListener('beforeunload', () => {
    saveDataToLocalStorage();
});

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    saveDataToLocalStorage();
  }
});

// ================= import font or csv ========================
function openCsvOrFont() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.csv,.ttf,.otf';
  fileInput.onchange = () => {
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = () => {
      const fileData = reader.result;
      if (file.type === 'text/csv') {
        addCsvToTable(fileData);
      } else if (file.type === 'font/ttf' || file.type === 'font/otf') {
        const reader = new FileReader();
        reader.onload = () => {
          const fontData = reader.result.split(',')[1];
          try {
            localStorage.setItem('selectedFont', fontData);
            alert('Selected font saved to local storage!');
          } catch (e) {
            alert('Error saving font to local storage: ' + e.message);
          }
        };
        reader.readAsDataURL(file);
      }
    };
    reader.readAsText(file);
  };
  fileInput.click();
}

function addCsvToTable(csvData) {
  const rows = csvData.split('\n').map(row => row.split(';'));
  rows.slice(0, 30).forEach((row, rowIndex) => {
    const tr = tbody.insertRow();
    row.forEach((cell, cellIndex) => {
      const td = tr.insertCell();
      td.textContent = cell;
    });
  });
let updatedAmount = 0;
const rowsU = document.querySelectorAll("tbody tr");
rowsU.forEach((line) => {
  const cellsU = line.cells;
  const rowDate = cellsU[0].textContent;
  const rowTime = Number(cellsU[1].textContent.split(":")[0]);
  if (rowDate === date && rowTime >= 2) {
    updatedAmount += Number(cellsU[2].textContent);
  }
});
document.getElementById("currentAmount").textContent = updatedAmount;
 // Store the CSV data in a global variable for later use
  window.csvWaterLog = csvData;
}
// ======= buttons ========
const saveButton = document.getElementById("svBt");
const customInput = document.getElementById("customInput");

saveButton.addEventListener("click", () => {
  const value = customInput.value;
  if (value !== "") {
  addRow(value);
  }
});

const btn125 = document.getElementById("btn-125");
const btn200 = document.getElementById("btn-200");
const btn250 = document.getElementById("btn-250");
const btn500 = document.getElementById("btn-500");

btn125.addEventListener("click", function() {
const value = btn125.value;
addRow(value);
});
btn200.addEventListener("click", () => {
  const value = btn200.value;
  addRow(value);
});
btn250.addEventListener("click", () => {
  const value = btn250.value;
  addRow(value);
});
btn500.addEventListener("click", () => {
  const value = btn500.value;
  addRow(value);
});

// ========= popup =====
function showPopup() {
  const popup = document.body.querySelector('#popup')
  popup.classList.add('slide-in-blurred-top');
  popup.style.display= 'flex';
  
  const form = document.getElementById('ifttt-form');
  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const inputWater = document.querySelector('[name="waterTarget"]');
    if (inputWater.value!==""){
    localStorage.setItem('waterTarget', inputWater.value);
    }
    
    const inputKey = document.querySelector('[name="iftttKeyInput"]');
    if (inputKey.value!==""){
    localStorage.setItem('iftttKey', inputKey.value);
    }
    popup.classList.remove('slide-in-blurred-top');
    popup.classList.add('slide-out-blurred-top');
    
    setTimeout(() => {
      popup.classList.remove('slide-out-blurred-top');
      popup.style.display= 'none';
    }, 450);
  });
}

function checkWaterTarget() {
  if (!localStorage.getItem('waterTarget')) {
    setTimeout(() => {
      showPopup();
      }, 250);
  }
}

function sendPostRequest(value, apiKey) {
  const script = document.createElement('script');
  const url = 'https://maker.ifttt.com/trigger/currentWater/with/key/' + apiKey;
  script.src = `${url}?value1=${encodeURIComponent(value)}`;
  document.body.appendChild(script);
}

const currentAmount = document.getElementById('currentAmount');
// create a new observer instance
const observer = new MutationObserver((mutationsList, observer) => {
  // iterate through the mutations
  for (let mutation of mutationsList) {
    if (mutation.type === 'childList' && mutation.target === currentAmount) {
      // your code to execute when the contents of "currentAmount" change goes here
      // send current level
      if (localStorage.getItem('iftttKey')){
        const value = document.getElementById('currentAmount').textContent
        const key = localStorage.getItem('iftttKey')
        sendPostRequest(value, key);
      }
      // update water level
      //increaseWaterLevel()
    }
  }
});

// configure the observer to watch for changes to the contents of the "currentAmount" div
observer.observe(currentAmount, { childList: true });

function clearLocalStorage() {
  localStorage.clear();
  const tbody = document.querySelector('tbody');
  tbody.innerHTML = '';
  document.querySelector('#currentAmount').textContent = '0'
}

checkWaterTarget()

// ============= rise water level ====
let waterLevelEnd = 88;
let waterLevelStart = 100;

const waterElem = document.getElementById('niceWaves');

function increaseWaterLevel() {
  const storedWaterTarget = localStorage.getItem('waterTarget')
  const currentWaterAmount = document.getElementById('currentAmount').value
   let waveMarginTopUpdate = 85 - (currentWaterAmount*(85/currentTargetWater))-3
  
  waterElem.style.animation = '';
  setTimeout(() => {
    document.documentElement.style.setProperty('--water-level-start', waterLevelStart + '%');
    document.documentElement.style.setProperty('--water-level-end', waterLevelEnd + '%');
    waterElem.style.animation = 'riseWater .5s ease-in-out forwards';
  }, 00);
}
//waterElem.style.animation = 'riseWaterInitial .4s ease-in-out forwards'
// ===== dark mode ====
// const body = document.querySelector('body');
// if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
//    body.classList.add('dark-theme');
// } else {
//    body.classList.remove('dark-theme');
// }
</script>
</body>
</html>
